------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  sim12
       log:  U:\Stata\Ado\Devel\gmatch\sims/sim12/logfile.log
  log type:  text
 opened on:  22 Mar 2019, 14:13:43

. 
. *! $Id: sim12.do,v f66ae0b6262a 2019/03/22 15:59:52 kkranker $
. *! BPO CBPS Simulation
. // See if the typo on page 215 of the I-R article explains differences between our and their results.
. //
. *! By Keith Kranker
. // Last updated $Date: 2019/03/22 15:59:52 $
. //
. // Copyright (C) Mathematica Policy Research, Inc.
. // This code cannot be copied, distributed or used without the express written
. // permission of Mathematica Policy Research, Inc.
. 
. mac list _sim
_sim:           12

. 
. // DGP is saved in a separate .ado file
. adopath ++ "./sims"
  [1]              "./sims"
  [2]  (BASE)      "C:\Program Files (x86)\Stata15\ado\base/"
  [3]  (SITE)      "C:\Program Files (x86)\Stata15\ado\site/"
  [4]              "."
  [5]  (PERSONAL)  "U:\Stata\Ado\personal/"
  [6]  (PLUS)      "U:\Stata\Ado\plus/"
  [7]  (OLDPLACE)  "C:\Users\kkranker\Documents\Stata\Ado/"
  [8]              "U:\Stata\Ado\personal"
  [9]              "U:\Stata\Ado\plus"
  [10]             "U:\Stata\Stata-Common-Code"
  [11]             "C:\Users\kkranker\Documents\Stata\Stata-Common-Code"

. which dgp_ksir
./sims\dgp_ksir.ado
*! $Id: dgp_ksir.ado,v f66ae0b6262a 2019/03/22 15:59:52 kkranker $
*! Data generating processe (DGP) senarios from:
*! By Keith Kranker

. which onerep_ksir
./sims\onerep_ksir.ado
*! $Id: onerep_ksir.ado,v f66ae0b6262a 2019/03/22 15:59:52 kkranker $
*! One replication of the Simulations with DGP_KSIR.ADO
*! By Keith Kranker

. which sim_reshape
./sims\sim_reshape.ado
*! $Id: sim_reshape.ado,v f66ae0b6262a 2019/03/22 15:59:52 kkranker $
*! Reshapes the outpute from simmulate: from wide to tall
*! By Keith Kranker

. 
. // control simulations
. local reps 2500

. 
. // other settings
. set seed `sim'  //  1 for simulation 1, 2 for simulation 2, etc.

. set matsize `c(max_matsize)'

. set maxiter 50

. set scheme mpr

. 
. // ------------------------------------------------------------------------
. // setup simulations
. // ------------------------------------------------------------------------
. 
. // options
. parallel setclusters `=min(8, c(processors_max)-1)'
N Clusters: 8
Stata dir:  C:\Program Files (x86)\Stata15/StataMP-64.exe

. local simopts    expr(_b) reps(\`reps') processors(`=c(processors_max)')

. local commonopts n(200 1000) ///
>                  estimators(ipw_true_ps ipw ipwcbps cbps) augmented ///
>                  ate ///
>                  iter(\`c(maxiter)') cformat(%9.3fc) pformat(%5.3f) sformat(%7.3f) pooledvariance

.                  quietly

. 
. // ------------------------------------------------------------------------
. // multiple matching approaches
. // difference in means and augmented
. // with the I-R definition of X4
. // ------------------------------------------------------------------------
. 
. // onerep_ksir, `commonopts' irversion
. // drop _all
. 
. parallel sim, `simopts': onerep_ksir, `commonopts' irversion
Warning: No data loaded.
--------------------------------------------------------------------------------
Parallel Computing with Stata
Clusters   : 8
pll_id     : 7g43tzbcq5
Running at : U:\Stata\Ado\Devel\gmatch
Randtype   : datetime
Waiting for the clusters to finish...
cluster 0008 has exited without error...
cluster 0007 has exited without error...
cluster 0002 has exited without error...
cluster 0004 has exited without error...
cluster 0003 has exited without error...
cluster 0001 has exited without error...
cluster 0006 has exited without error...
cluster 0005 has exited without error...
--------------------------------------------------------------------------------
Enter -parallel printlog #- to checkout logfiles.
--------------------------------------------------------------------------------

. 
. qui compress

. save sims/sim`sim'/Data_Unprocessed_1.dta, replace
file sims/sim12/Data_Unprocessed_1.dta saved

. 
. sim_reshape

Before reshape:


Contains data from sims/sim12/Data_Unprocessed_1.dta
  obs:         2,500                          simulate: onerep_ksir
 vars:           238                          22 Mar 2019 15:17
 size:     2,015,000                          
Sorted by: 
2 prefixes:
_prefixes:      I_1 I_2
4 estimators:
_ests:          ipw_true_ps ipw ipwcbps cbps
(simulate: onerep_ksir)
(39,984 missing values generated)
(39,984 missing values generated)
(39984 real changes made, 39984 to missing)
(39,984 missing values generated)

After reshape:


Contains data from D:\TEMP\kkranker\ST_4710_000001.tmp
  obs:        40,000                          simulate: onerep_ksir
 vars:            28                          22 Mar 2019 15:17
 size:     3,760,000                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
result          byte    %36.0g     result     
dataset         byte    %10.0g                
dgp             byte    %8.0g      dgp        
true            byte    %7.4f                 
N               int     %7.0g                 
estimator       byte    %11.0g     est        
augmented       byte    %13.0g     aug        
rep             int     %9.0g                 
Nt              int     %7.0g                 
impact_est      float   %7.4f                 
sd_error        float   %7.4f                 
bias            float   %7.4f                 
error_sqr       float   %7.4f                 
power_zstat_0   float   %7.4f                 
p_0             float   %7.4f                 
reject_0        byte    %7.0g                 
covered         byte    %7.0g                 
bal_max_asd     float   %7.4f                 
bal_mean_asd    float   %7.4f                 
wgt_sd          float   %7.4f                 
wgt_cv          float   %7.4f                 
wgt_skewness    float   %7.4f                 
wgt_kurtosis    float   %7.4f                 
wgt_max         float   %7.1f                 
rmse            double  %7.4f                 
impact_est_var  double  %7.4f                 
mae             float   %7.4f                 
pct_bias        double  %6.1f                 
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: result  dataset  dgp  true  N  estimator  augmented  rep
     Note: Dataset has changed since last saved.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
      result |     40,000         8.5     4.60983          1         16
     dataset |     40,000         1.5    .5000063          1          2
         dgp |     40,000           8           0          8          8
        true |     40,000           0           0          0          0
           N |     40,000         600     400.005        200       1000
   estimator |     40,000         6.5    2.692616          2          9
   augmented |     40,000          .5    .5000063          0          1
         rep |     40,000      1250.5    721.6968          1       2500
          Nt |     40,000    300.0642    200.0709         73        557
  impact_est |     40,000   -2.239737    4.383186  -35.55476   104.8718
    sd_error |     40,000    2.635698    1.530871   .8745194   7.439111
        bias |     40,000   -2.239737    4.383186  -35.55476   104.8718
   error_sqr |     40,000    24.22826    164.1871   3.23e-07    10998.1
power_zsta~0 |     35,000        .025           0       .025       .025
         p_0 |     40,000    .2885566    .2981614          0   .9998621
    reject_0 |     40,000     .323175    .4676948          0          1
     covered |     40,000     .676825    .4676948          0          1
 bal_max_asd |     40,000    .1246928    .1384958   2.02e-10   1.980756
bal_mean_asd |     35,000    .0646523    .0833147   7.55e-11   1.303669
      wgt_sd |     40,000    .5674743    .5902316          0   15.79576
      wgt_cv |     40,000    .5674743    .5902316          0   15.79576
wgt_skewness |     30,000    .3171408    .1784694   .0618295   .9965253
wgt_kurtosis |     30,000    .1830669    .1873949   .0108145   .9953741
     wgt_max |     40,000    9.423935    16.38487          1   499.6776
        rmse |         16    4.547292    1.946044   1.248199   8.393249
impact_est~r |         16    15.97431    23.23345   1.551929   69.05319
         mae |         16    3.217896    1.033012   .8301545   5.150162
    pct_bias |         16   -116.3294    107.1358  -276.1805   16.06395
Number of rows:

----------------------------
augmented,    |  true and N 
dgp and       | -- 0.0000 --
estimator     |   200   1000
--------------+-------------
Unadjusted    |
I             |
  IPW_TRUE_PS | 2,500  2,500
      IPWCBPS | 2,500  2,500
         CBPS | 2,500  2,500
          IPW | 2,500  2,500
--------------+-------------
Reg. adjusted |
I             |
  IPW_TRUE_PS | 2,500  2,500
      IPWCBPS | 2,500  2,500
         CBPS | 2,500  2,500
          IPW | 2,500  2,500
----------------------------
Number of rows with nonmissing impact_est:

----------------------------
augmented,    |  true and N 
dgp and       | -- 0.0000 --
estimator     |   200   1000
--------------+-------------
Unadjusted    |
I             |
  IPW_TRUE_PS | 2,500  2,500
      IPWCBPS | 2,500  2,500
         CBPS | 2,500  2,500
          IPW | 2,500  2,500
--------------+-------------
Reg. adjusted |
I             |
  IPW_TRUE_PS | 2,500  2,500
      IPWCBPS | 2,500  2,500
         CBPS | 2,500  2,500
          IPW | 2,500  2,500
----------------------------
Number of rows with nonmissing rmse:

--------------------------
augmented,    | true and N
dgp and       | - 0.0000 -
estimator     |  200  1000
--------------+-----------
Unadjusted    |
I             |
  IPW_TRUE_PS |    1     1
      IPWCBPS |    1     1
         CBPS |    1     1
          IPW |    1     1
--------------+-----------
Reg. adjusted |
I             |
  IPW_TRUE_PS |    1     1
      IPWCBPS |    1     1
         CBPS |    1     1
          IPW |    1     1
--------------------------

. gen irversion = 1

. 
. tempfile f1

. save "`f1'", replace
(note: file D:\TEMP\kkranker\ST_4710_000001.tmp not found)
file D:\TEMP\kkranker\ST_4710_000001.tmp saved

. drop _all

. 
. // ------------------------------------------------------------------------
. // multiple matching approaches
. // difference in means and augmented
. // with the K-S definition of X4
. // ------------------------------------------------------------------------
. 
. // onerep_ksir, `commonopts'
. // drop _all
. 
. parallel sim, `simopts': onerep_ksir, `commonopts'
Warning: No data loaded.
--------------------------------------------------------------------------------
Parallel Computing with Stata
Clusters   : 8
pll_id     : j8l2vojg37
Running at : U:\Stata\Ado\Devel\gmatch
Randtype   : datetime
Waiting for the clusters to finish...
cluster 0004 has exited without error...
cluster 0001 has exited without error...
cluster 0005 has exited without error...
cluster 0006 has exited without error...
cluster 0008 has exited without error...
cluster 0003 has exited without error...
cluster 0007 has exited without error...
cluster 0002 has exited without error...
--------------------------------------------------------------------------------
Enter -parallel printlog #- to checkout logfiles.
--------------------------------------------------------------------------------

. 
. qui compress

. save sims/sim`sim'/Data_Unprocessed_0.dta, replace
file sims/sim12/Data_Unprocessed_0.dta saved

. 
. sim_reshape

Before reshape:


Contains data from sims/sim12/Data_Unprocessed_0.dta
  obs:         2,500                          simulate: onerep_ksir
 vars:           238                          22 Mar 2019 16:21
 size:     2,015,000                          
Sorted by: 
2 prefixes:
_prefixes:      I_1 I_2
4 estimators:
_ests:          ipw_true_ps ipw ipwcbps cbps
(simulate: onerep_ksir)
(39,984 missing values generated)
(39,984 missing values generated)
(39984 real changes made, 39984 to missing)
(39,984 missing values generated)

After reshape:


Contains data from D:\TEMP\kkranker\ST_4710_000002.tmp
  obs:        40,000                          simulate: onerep_ksir
 vars:            28                          22 Mar 2019 16:21
 size:     3,760,000                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
result          byte    %36.0g     result     
dataset         byte    %10.0g                
dgp             byte    %8.0g      dgp        
true            byte    %7.4f                 
N               int     %7.0g                 
estimator       byte    %11.0g     est        
augmented       byte    %13.0g     aug        
rep             int     %9.0g                 
Nt              int     %7.0g                 
impact_est      float   %7.4f                 
sd_error        float   %7.4f                 
bias            float   %7.4f                 
error_sqr       float   %7.4f                 
power_zstat_0   float   %7.4f                 
p_0             float   %7.4f                 
reject_0        byte    %7.0g                 
covered         byte    %7.0g                 
bal_max_asd     float   %7.4f                 
bal_mean_asd    float   %7.4f                 
wgt_sd          float   %7.4f                 
wgt_cv          float   %7.4f                 
wgt_skewness    float   %7.4f                 
wgt_kurtosis    float   %7.4f                 
wgt_max         float   %7.1f                 
rmse            double  %7.4f                 
impact_est_var  double  %7.4f                 
mae             float   %7.4f                 
pct_bias        double  %6.1f                 
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: result  dataset  dgp  true  N  estimator  augmented  rep
     Note: Dataset has changed since last saved.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
      result |     40,000         8.5     4.60983          1         16
     dataset |     40,000         1.5    .5000063          1          2
         dgp |     40,000           8           0          8          8
        true |     40,000           0           0          0          0
           N |     40,000         600     400.005        200       1000
   estimator |     40,000         6.5    2.692616          2          9
   augmented |     40,000          .5    .5000063          0          1
         rep |     40,000      1250.5    721.6968          1       2500
          Nt |     40,000     299.937    200.3871         75        550
  impact_est |     40,000   -3.639913    5.210483    -60.999    117.487
    sd_error |     40,000    2.681261     1.50908   .9133461   8.026052
        bias |     40,000   -3.639913    5.210483    -60.999    117.487
   error_sqr |     40,000    40.39742    184.0359   3.40e-09    13803.2
power_zsta~0 |     35,000        .025           0       .025       .025
         p_0 |     40,000    .2158251    .2793164          0   .9999909
    reject_0 |     40,000     .461775    .4985429          0          1
     covered |     40,000     .538225    .4985429          0          1
 bal_max_asd |     40,000    .1333846    .1567044   1.68e-10   1.947846
bal_mean_asd |     35,000    .0645641    .0843681   1.25e-10   1.203697
      wgt_sd |     40,000    .6110472    .7287503          0   15.32826
      wgt_cv |     40,000    .6110472    .7287503          0   15.32826
wgt_skewness |     30,000    .3532494     .195036   .0523468    .996239
wgt_kurtosis |     30,000    .2176901    .2104022    .014522   .9949912
     wgt_max |     40,000    10.92487    21.16201          1    484.872
        rmse |         16    6.007261    2.144198   1.451792   10.22908
impact_est~r |         16     19.9431    29.71419   2.099774   103.1173
         mae |         16    4.603647    1.646391   .9682341   6.753818
    pct_bias |         16   -153.1953    133.8117  -340.2748   12.29185
Number of rows:

----------------------------
augmented,    |  true and N 
dgp and       | -- 0.0000 --
estimator     |   200   1000
--------------+-------------
Unadjusted    |
I             |
  IPW_TRUE_PS | 2,500  2,500
      IPWCBPS | 2,500  2,500
         CBPS | 2,500  2,500
          IPW | 2,500  2,500
--------------+-------------
Reg. adjusted |
I             |
  IPW_TRUE_PS | 2,500  2,500
      IPWCBPS | 2,500  2,500
         CBPS | 2,500  2,500
          IPW | 2,500  2,500
----------------------------
Number of rows with nonmissing impact_est:

----------------------------
augmented,    |  true and N 
dgp and       | -- 0.0000 --
estimator     |   200   1000
--------------+-------------
Unadjusted    |
I             |
  IPW_TRUE_PS | 2,500  2,500
      IPWCBPS | 2,500  2,500
         CBPS | 2,500  2,500
          IPW | 2,500  2,500
--------------+-------------
Reg. adjusted |
I             |
  IPW_TRUE_PS | 2,500  2,500
      IPWCBPS | 2,500  2,500
         CBPS | 2,500  2,500
          IPW | 2,500  2,500
----------------------------
Number of rows with nonmissing rmse:

--------------------------
augmented,    | true and N
dgp and       | - 0.0000 -
estimator     |  200  1000
--------------+-----------
Unadjusted    |
I             |
  IPW_TRUE_PS |    1     1
      IPWCBPS |    1     1
         CBPS |    1     1
          IPW |    1     1
--------------+-----------
Reg. adjusted |
I             |
  IPW_TRUE_PS |    1     1
      IPWCBPS |    1     1
         CBPS |    1     1
          IPW |    1     1
--------------------------

. gen irversion = 0

. 
. 
. // ------------------------------------------------------------------------
. // summarize results
. // ------------------------------------------------------------------------
. 
. append using "`f1'"
(label dgp already defined)
(label est already defined)
(label aug already defined)
(label result already defined)

. label define irversion 0 "Kang-Shafler" 1 "Ima-Ratkovic"

. label val irversion irversion

. qui compress

. 
. save sims/sim`sim'/Data.dta, replace
file sims/sim12/Data.dta saved

. 
. bys irversion: table augmented estimator, by(N) c(count bias)

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> irversion = Kang-Shafler

------------------------------------------------------------------
N and         |                     estimator                     
augmented     | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
--------------+---------------------------------------------------
200           |
   Unadjusted |       2,500        2,500        2,500        2,500
Reg. adjusted |       2,500        2,500        2,500        2,500
--------------+---------------------------------------------------
1000          |
   Unadjusted |       2,500        2,500        2,500        2,500
Reg. adjusted |       2,500        2,500        2,500        2,500
------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> irversion = Ima-Ratkovic

------------------------------------------------------------------
N and         |                     estimator                     
augmented     | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
--------------+---------------------------------------------------
200           |
   Unadjusted |       2,500        2,500        2,500        2,500
Reg. adjusted |       2,500        2,500        2,500        2,500
--------------+---------------------------------------------------
1000          |
   Unadjusted |       2,500        2,500        2,500        2,500
Reg. adjusted |       2,500        2,500        2,500        2,500
------------------------------------------------------------------

. 
. foreach v of var bias rmse {
  2.   di _n(2) as res `"`v'  `:var lab `v''"'
  3.   bys irversion: table augmented estimator, by(N) c(mean `v')
  4. }


bias  

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> irversion = Kang-Shafler

------------------------------------------------------------------
N and         |                     estimator                     
augmented     | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
--------------+---------------------------------------------------
200           |
   Unadjusted |     -0.5111      -6.6999      -5.3191      -2.0106
Reg. adjusted |     -0.3585      -5.2676      -5.1562      -5.2711
--------------+---------------------------------------------------
1000          |
   Unadjusted |     -0.0761      -4.8116      -5.9984       1.2482
Reg. adjusted |     -0.0936      -5.9822      -5.9458      -5.9851
------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> irversion = Ima-Ratkovic

------------------------------------------------------------------
N and         |                     estimator                     
augmented     | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
--------------+---------------------------------------------------
200           |
   Unadjusted |     -0.1954      -5.0877      -3.3816      -1.1921
Reg. adjusted |     -0.2154      -3.2820      -3.2737      -3.2748
--------------+---------------------------------------------------
1000          |
   Unadjusted |      0.0163      -3.0489      -3.5610       1.3309
Reg. adjusted |     -0.0818      -3.5262      -3.5389      -3.5235
------------------------------------------------------------------


rmse  

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> irversion = Kang-Shafler

------------------------------------------------------------------
N and         |                     estimator                     
augmented     | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
--------------+---------------------------------------------------
200           |
   Unadjusted |      6.8815       7.5464       6.3013       9.0001
Reg. adjusted |      3.0260       6.0794       6.0602       6.2452
--------------+---------------------------------------------------
1000          |
   Unadjusted |      3.1049       5.2247       6.2729      10.2291
Reg. adjusted |      1.4518       6.2393       6.1972       6.2563
------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> irversion = Ima-Ratkovic

------------------------------------------------------------------
N and         |                     estimator                     
augmented     | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
--------------+---------------------------------------------------
200           |
   Unadjusted |      6.8229       6.1046       4.3967       8.3932
Reg. adjusted |      2.6838       4.1978       4.2655       4.2452
--------------+---------------------------------------------------
1000          |
   Unadjusted |      3.1372       3.7602       3.7922       8.3894
Reg. adjusted |      1.2482       3.7507       3.7636       3.8053
------------------------------------------------------------------

. 
. log close sim`sim'
      name:  sim12
       log:  U:\Stata\Ado\Devel\gmatch\sims/sim12/logfile.log
  log type:  text
 closed on:  22 Mar 2019, 16:21:28
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
