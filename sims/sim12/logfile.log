------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  sim12
       log:  U:\Stata\Ado\Devel\gmatch\sims/sim12/logfile.log
  log type:  text
 opened on:  18 Mar 2019, 18:40:48

. 
. *! $Id$
. *! BPO CBPS Simulation
. // See if the typo on page 215 of the I-R article explains differences between our and their results.
. //
. *! By Keith Kranker
. // Last updated $Date$
. //
. // Copyright (C) Mathematica Policy Research, Inc.
. // This code cannot be copied, distributed or used without the express written
. // permission of Mathematica Policy Research, Inc.
. 
. mac list _sim
_sim:           12

. 
. // DGP is saved in a separate .ado file
. adopath ++ "./sims"
  [1]              "./sims"
  [2]  (BASE)      "C:\Program Files (x86)\Stata15\ado\base/"
  [3]  (SITE)      "C:\Program Files (x86)\Stata15\ado\site/"
  [4]              "."
  [5]  (PERSONAL)  "U:\Stata\Ado\personal/"
  [6]  (PLUS)      "U:\Stata\Ado\plus/"
  [7]  (OLDPLACE)  "C:\Users\kkranker\Documents\Stata\Ado/"
  [8]              "U:\Stata\Ado\personal"
  [9]              "U:\Stata\Ado\plus"
  [10]             "U:\Stata\Stata-Common-Code"
  [11]             "C:\Users\kkranker\Documents\Stata\Stata-Common-Code"

. adopath ++ "../gridsearchcv"
  [1]              "../gridsearchcv"
  [2]              "./sims"
  [3]  (BASE)      "C:\Program Files (x86)\Stata15\ado\base/"
  [4]  (SITE)      "C:\Program Files (x86)\Stata15\ado\site/"
  [5]              "."
  [6]  (PERSONAL)  "U:\Stata\Ado\personal/"
  [7]  (PLUS)      "U:\Stata\Ado\plus/"
  [8]  (OLDPLACE)  "C:\Users\kkranker\Documents\Stata\Ado/"
  [9]              "U:\Stata\Ado\personal"
  [10]             "U:\Stata\Ado\plus"
  [11]             "U:\Stata\Stata-Common-Code"
  [12]             "C:\Users\kkranker\Documents\Stata\Stata-Common-Code"

. which dgp_ssbgc
./sims\dgp_ssbgc.ado
*! $Id: dgp_ssbgc.ado,v 1bd3f7eb3235 2019/02/01 15:47:11 kkranker $
*! Data generating processe (DGP) senarios A through G from Setoguchi et al. (2008)
*! By Keith Kranker

. which onerep
./sims\onerep.ado
*! $Id: onerep.ado,v 0dd86927acba 2019/02/06 00:16:58 kkranker $
*! One replication of the Simulations
*! By Keith Kranker

. which sim_reshape
./sims\sim_reshape.ado
*! $Id: sim_reshape.ado,v 31285d72d38e 2019/03/05 00:29:14 kkranker $
*! Reshapes the outpute from simmulate: from wide to tall
*! By Keith Kranker

. which randomforest
U:\Stata\Ado\plus\r\randomforest.ado
*! version 1.2  June, 2018

. which gridsearchcv
../gridsearchcv\gridsearchcv.ado
*! $Id: gridsearchcv.ado,v 68af91001823 2019/02/14 21:58:57 kkranker $
*! Exhaustive search over specified parameter values for an estimator
*! By Keith Kranker
*! $Date: 2019/02/14 21:58:57 $

. 
. // control simulations
. local reps 1000

. local Nrange 200 1000

. 
. // other settings
. set seed `sim'  //  1 for simulation 1, 2 for simulation 2, etc.

. set matsize `c(max_matsize)'

. set maxiter 50

. set scheme mpr

. 
. // ------------------------------------------------------------------------
. // setup simulations
. // ------------------------------------------------------------------------
. 
. // options
. parallel setclusters `=min(8, c(processors_max)-1)'
N Clusters: 8
Stata dir:  C:\Program Files (x86)\Stata15/StataMP-64.exe

. local simopts    expr(_b) reps(\`reps') processors(`=c(processors_max)')

. local commonopts n(`Nrange') ///
>                  estimators(ipw_true_ps ipw ipwcbps cbps) augmented ///
>                  ate ///
>                  iter(\`c(maxiter)') cformat(%9.3fc) pformat(%5.3f) sformat(%7.3f) pooledvariance

.                  quietly

. 
. // ------------------------------------------------------------------------
. // multiple matching approaches
. // difference in means and augmented
. // with the I-R definition of X4
. // ------------------------------------------------------------------------
. 
. // onerep_ksir, `commonopts' irtypo
. // drop _all
. 
. parallel sim, `simopts': onerep_ksir, `commonopts' irtypo
Warning: No data loaded.
--------------------------------------------------------------------------------
Parallel Computing with Stata
Clusters   : 8
pll_id     : tpmeiou9h1
Running at : U:\Stata\Ado\Devel\gmatch
Randtype   : datetime
Waiting for the clusters to finish...
cluster 0004 has exited without error...
cluster 0007 has exited without error...
cluster 0008 has exited without error...
cluster 0003 has exited without error...
cluster 0006 has exited without error...
cluster 0002 has exited without error...
cluster 0001 has exited without error...
cluster 0005 has exited without error...
--------------------------------------------------------------------------------
Enter -parallel printlog #- to checkout logfiles.
--------------------------------------------------------------------------------

. 
. save sims/sim`sim'/Data_Unprocessed_1.dta, replace
(note: file sims/sim12/Data_Unprocessed_1.dta not found)
file sims/sim12/Data_Unprocessed_1.dta saved

. 
. sim_reshape

Before reshape:


Contains data from sims/sim12/Data_Unprocessed_1.dta
  obs:         1,000                          simulate: onerep_ksir
 vars:           238                          18 Mar 2019 19:09
 size:       952,000                          
Sorted by: 
2 prefixes:
_prefixes:      I_1 I_2
4 estimators:
_ests:          ipw_true_ps ipw ipwcbps cbps
(simulate: onerep_ksir)
(15,984 missing values generated)
(15,984 missing values generated)

After reshape:


Contains data from C:\Users\KKranker\AppData\Local\Temp\26\ST_3d58_000001.tmp
  obs:        16,000                          simulate: onerep_ksir
 vars:            26                          18 Mar 2019 19:09
 size:     1,312,000                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
result          byte    %36.0g     result     
dataset         byte    %10.0g                
dgp             byte    %8.0g      dgp        
true            byte    %7.4f                 
N               int     %7.0g                 
estimator       byte    %11.0g     est        
augmented       byte    %13.0g     aug        
rep             int     %9.0g                 
Nt              int     %7.0g                 
impact_est      float   %7.4f                 
sd_error        float   %7.4f                 
bias            float   %7.4f                 
error_sqr       float   %7.4f                 
power_zstat_0   float   %7.4f                 
p_0             float   %7.4f                 
reject_0        byte    %7.0g                 
covered         byte    %7.0g                 
bal_max_asd     float   %7.4f                 
bal_mean_asd    float   %7.4f                 
wgt_sd          float   %7.4f                 
wgt_cv          float   %7.4f                 
wgt_skewness    float   %7.4f                 
wgt_kurtosis    float   %7.4f                 
wgt_max         float   %7.1f                 
rmse            double  %7.4f                 
impact_est_var  double  %7.4f                 
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: result  dataset  dgp  true  N  estimator  augmented  rep
     Note: Dataset has changed since last saved.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
      result |     16,000         8.5    4.609916          1         16
     dataset |     16,000         1.5    .5000156          1          2
         dgp |     16,000           8           0          8          8
        true |     16,000           0           0          0          0
           N |     16,000         600    400.0125        200       1000
   estimator |     16,000         6.5    2.692667          2          9
   augmented |     16,000          .5    .5000156          0          1
         rep |     16,000       500.5     288.684          1       1000
          Nt |     16,000    299.9535    200.2793         77        547
  impact_est |     16,000    -3.51996    5.235749  -21.70636   110.5372
    sd_error |     16,000    2.679656    1.506884   .9098039   7.936375
        bias |     16,000    -3.51996    5.235749  -21.70636   110.5372
   error_sqr |     16,000    39.80147     201.718   1.85e-08   12218.47
power_zsta~0 |     14,000        .025           0       .025       .025
         p_0 |     16,000    .2197354    .2830592          0   .9999526
    reject_0 |     16,000      .45875    .4983111          0          1
     covered |     16,000      .54125    .4983111          0          1
 bal_max_asd |     16,000    .1330985    .1517808   1.46e-10   1.841298
bal_mean_asd |     14,000    .0644094    .0816541   4.91e-11   1.078789
      wgt_sd |     16,000    .6095873    .7195706          0   15.03778
      wgt_cv |     16,000    .6095873    .7195706          0   15.03778
wgt_skewness |     12,000    .3487965    .1931058   .0215519    .996308
wgt_kurtosis |     12,000    .2127173    .2076138   .0125194   .9950839
     wgt_max |     16,000    10.82416    20.97219          1   475.7134
        rmse |         16    5.946788    2.175545   1.470225   10.43827
impact_est~r |         16    20.32363    31.08813   2.163698   107.2488
Number of rows:

----------------------------
augmented,    |  true and N 
dgp and       | -- 0.0000 --
estimator     |   200   1000
--------------+-------------
Unadjusted    |
I             |
  IPW_TRUE_PS | 1,000  1,000
      IPWCBPS | 1,000  1,000
         CBPS | 1,000  1,000
          IPW | 1,000  1,000
--------------+-------------
Reg. adjusted |
I             |
  IPW_TRUE_PS | 1,000  1,000
      IPWCBPS | 1,000  1,000
         CBPS | 1,000  1,000
          IPW | 1,000  1,000
----------------------------
Number of rows with nonmissing impact_est:

----------------------------
augmented,    |  true and N 
dgp and       | -- 0.0000 --
estimator     |   200   1000
--------------+-------------
Unadjusted    |
I             |
  IPW_TRUE_PS | 1,000  1,000
      IPWCBPS | 1,000  1,000
         CBPS | 1,000  1,000
          IPW | 1,000  1,000
--------------+-------------
Reg. adjusted |
I             |
  IPW_TRUE_PS | 1,000  1,000
      IPWCBPS | 1,000  1,000
         CBPS | 1,000  1,000
          IPW | 1,000  1,000
----------------------------
Number of rows with nonmissing rmse:

--------------------------
augmented,    | true and N
dgp and       | - 0.0000 -
estimator     |  200  1000
--------------+-----------
Unadjusted    |
I             |
  IPW_TRUE_PS |    1     1
      IPWCBPS |    1     1
         CBPS |    1     1
          IPW |    1     1
--------------+-----------
Reg. adjusted |
I             |
  IPW_TRUE_PS |    1     1
      IPWCBPS |    1     1
         CBPS |    1     1
          IPW |    1     1
--------------------------

. gen irtypo = 1

. 
. tempfile f1

. save "`f1'", replace
(note: file C:\Users\KKranker\AppData\Local\Temp\26\ST_3d58_000001.tmp not found)
file C:\Users\KKranker\AppData\Local\Temp\26\ST_3d58_000001.tmp saved

. drop _all

. 
. // ------------------------------------------------------------------------
. // multiple matching approaches
. // difference in means and augmented
. // with the K-S definition of X4
. // ------------------------------------------------------------------------
. 
. // onerep_ksir, `commonopts'
. // drop _all
. 
. parallel sim, `simopts': onerep_ksir, `commonopts'
Warning: No data loaded.
--------------------------------------------------------------------------------
Parallel Computing with Stata
Clusters   : 8
pll_id     : 76ghrwcad3
Running at : U:\Stata\Ado\Devel\gmatch
Randtype   : datetime
Waiting for the clusters to finish...
cluster 0003 has exited without error...
cluster 0002 has exited without error...
cluster 0006 has exited without error...
cluster 0007 has exited without error...
cluster 0005 has exited without error...
cluster 0008 has exited without error...
cluster 0001 has exited without error...
cluster 0004 has exited without error...
--------------------------------------------------------------------------------
Enter -parallel printlog #- to checkout logfiles.
--------------------------------------------------------------------------------

. 
. save sims/sim`sim'/Data_Unprocessed_0.dta, replace
(note: file sims/sim12/Data_Unprocessed_0.dta not found)
file sims/sim12/Data_Unprocessed_0.dta saved

. 
. sim_reshape

Before reshape:


Contains data from sims/sim12/Data_Unprocessed_0.dta
  obs:         1,000                          simulate: onerep_ksir
 vars:           238                          18 Mar 2019 19:38
 size:       952,000                          
Sorted by: 
2 prefixes:
_prefixes:      I_1 I_2
4 estimators:
_ests:          ipw_true_ps ipw ipwcbps cbps
(simulate: onerep_ksir)
(15,984 missing values generated)
(15,984 missing values generated)

After reshape:


Contains data from C:\Users\KKranker\AppData\Local\Temp\26\ST_3d58_000002.tmp
  obs:        16,000                          simulate: onerep_ksir
 vars:            26                          18 Mar 2019 19:38
 size:     1,312,000                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
result          byte    %36.0g     result     
dataset         byte    %10.0g                
dgp             byte    %8.0g      dgp        
true            byte    %7.4f                 
N               int     %7.0g                 
estimator       byte    %11.0g     est        
augmented       byte    %13.0g     aug        
rep             int     %9.0g                 
Nt              int     %7.0g                 
impact_est      float   %7.4f                 
sd_error        float   %7.4f                 
bias            float   %7.4f                 
error_sqr       float   %7.4f                 
power_zstat_0   float   %7.4f                 
p_0             float   %7.4f                 
reject_0        byte    %7.0g                 
covered         byte    %7.0g                 
bal_max_asd     float   %7.4f                 
bal_mean_asd    float   %7.4f                 
wgt_sd          float   %7.4f                 
wgt_cv          float   %7.4f                 
wgt_skewness    float   %7.4f                 
wgt_kurtosis    float   %7.4f                 
wgt_max         float   %7.1f                 
rmse            double  %7.4f                 
impact_est_var  double  %7.4f                 
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: result  dataset  dgp  true  N  estimator  augmented  rep
     Note: Dataset has changed since last saved.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
      result |     16,000         8.5    4.609916          1         16
     dataset |     16,000         1.5    .5000156          1          2
         dgp |     16,000           8           0          8          8
        true |     16,000           0           0          0          0
           N |     16,000         600    400.0125        200       1000
   estimator |     16,000         6.5    2.692667          2          9
   augmented |     16,000          .5    .5000156          0          1
         rep |     16,000       500.5     288.684          1       1000
          Nt |     16,000       299.7    200.3763         71        554
  impact_est |     16,000   -3.587001    5.182727  -40.90751   104.7606
    sd_error |     16,000    2.680445    1.508898   .9199535   7.696814
        bias |     16,000   -3.587001    5.182727  -40.90751   104.7606
   error_sqr |     16,000    39.72556    209.4312   1.07e-09   10974.78
power_zsta~0 |     14,000        .025           0       .025       .025
         p_0 |     16,000    .2184843    .2797718          0   .9999777
    reject_0 |     16,000    .4580625    .4982537          0          1
     covered |     16,000    .5419375    .4982537          0          1
 bal_max_asd |     16,000    .1317396    .1541395   7.19e-11   1.937163
bal_mean_asd |     14,000    .0640378    .0841964   3.55e-11   1.301458
      wgt_sd |     16,000    .6080365     .721067          0   14.99626
      wgt_cv |     16,000    .6080365     .721067          0   14.99626
wgt_skewness |     12,000    .3533674    .1948317   .0870215   .9961967
wgt_kurtosis |     12,000     .217788    .2097196   .0141066   .9949362
     wgt_max |     16,000     10.8265    20.87827          1   474.3192
        rmse |         16    5.949209    2.149723   1.405208   10.18622
impact_est~r |         16    19.94932    29.91264   1.975905   102.8382
Number of rows:

----------------------------
augmented,    |  true and N 
dgp and       | -- 0.0000 --
estimator     |   200   1000
--------------+-------------
Unadjusted    |
I             |
  IPW_TRUE_PS | 1,000  1,000
      IPWCBPS | 1,000  1,000
         CBPS | 1,000  1,000
          IPW | 1,000  1,000
--------------+-------------
Reg. adjusted |
I             |
  IPW_TRUE_PS | 1,000  1,000
      IPWCBPS | 1,000  1,000
         CBPS | 1,000  1,000
          IPW | 1,000  1,000
----------------------------
Number of rows with nonmissing impact_est:

----------------------------
augmented,    |  true and N 
dgp and       | -- 0.0000 --
estimator     |   200   1000
--------------+-------------
Unadjusted    |
I             |
  IPW_TRUE_PS | 1,000  1,000
      IPWCBPS | 1,000  1,000
         CBPS | 1,000  1,000
          IPW | 1,000  1,000
--------------+-------------
Reg. adjusted |
I             |
  IPW_TRUE_PS | 1,000  1,000
      IPWCBPS | 1,000  1,000
         CBPS | 1,000  1,000
          IPW | 1,000  1,000
----------------------------
Number of rows with nonmissing rmse:

--------------------------
augmented,    | true and N
dgp and       | - 0.0000 -
estimator     |  200  1000
--------------+-----------
Unadjusted    |
I             |
  IPW_TRUE_PS |    1     1
      IPWCBPS |    1     1
         CBPS |    1     1
          IPW |    1     1
--------------+-----------
Reg. adjusted |
I             |
  IPW_TRUE_PS |    1     1
      IPWCBPS |    1     1
         CBPS |    1     1
          IPW |    1     1
--------------------------

. gen irtypo = 0

. 
. 
. // ------------------------------------------------------------------------
. // summarize results
. // ------------------------------------------------------------------------
. 
. append using "`f1'"
(label dgp already defined)
(label est already defined)
(label aug already defined)
(label result already defined)

. save sims/sim`sim'/Data.dta, replace
(note: file sims/sim12/Data.dta not found)
file sims/sim12/Data.dta saved

. sort irtypo

. 
. by irtypo: table augmented estimator, by(N) c(count bias)

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> irtypo = 0

------------------------------------------------------------------
N and         |                     estimator                     
augmented     | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
--------------+---------------------------------------------------
200           |
   Unadjusted |       1,000        1,000        1,000        1,000
Reg. adjusted |       1,000        1,000        1,000        1,000
--------------+---------------------------------------------------
1000          |
   Unadjusted |       1,000        1,000        1,000        1,000
Reg. adjusted |       1,000        1,000        1,000        1,000
------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> irtypo = 1

------------------------------------------------------------------
N and         |                     estimator                     
augmented     | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
--------------+---------------------------------------------------
200           |
   Unadjusted |       1,000        1,000        1,000        1,000
Reg. adjusted |       1,000        1,000        1,000        1,000
--------------+---------------------------------------------------
1000          |
   Unadjusted |       1,000        1,000        1,000        1,000
Reg. adjusted |       1,000        1,000        1,000        1,000
------------------------------------------------------------------

. 
. foreach v of var bias rmse {
  2.   di _n(2) as res `"`v'  `:var lab `v''"'
  3.   by irtypo: table augmented estimator, by(N) c(mean `v')
  4. }


bias  

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> irtypo = 0

------------------------------------------------------------------
N and         |                     estimator                     
augmented     | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
--------------+---------------------------------------------------
200           |
   Unadjusted |     -0.3195      -6.5054      -5.2170      -2.2086
Reg. adjusted |     -0.2343      -5.1623      -5.0480      -5.1776
--------------+---------------------------------------------------
1000          |
   Unadjusted |     -0.1120      -4.8042      -5.9147       1.0118
Reg. adjusted |     -0.0261      -5.8982      -5.8615      -5.9145
------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> irtypo = 1

------------------------------------------------------------------
N and         |                     estimator                     
augmented     | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
--------------+---------------------------------------------------
200           |
   Unadjusted |     -0.3495      -6.5524      -5.1325      -2.0068
Reg. adjusted |     -0.1831      -5.0923      -4.9782      -5.0746
--------------+---------------------------------------------------
1000          |
   Unadjusted |     -0.0850      -4.7610      -5.8784       1.3476
Reg. adjusted |      0.0052      -5.8746      -5.8364      -5.8671
------------------------------------------------------------------


rmse  

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> irtypo = 0

------------------------------------------------------------------
N and         |                     estimator                     
augmented     | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
--------------+---------------------------------------------------
200           |
   Unadjusted |      6.9650       7.4369       6.1551       9.0929
Reg. adjusted |      2.9173       5.9370       5.9079       6.1309
--------------+---------------------------------------------------
1000          |
   Unadjusted |      3.1811       5.2533       6.1792      10.1862
Reg. adjusted |      1.4052       6.1420       6.0997       6.1977
------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> irtypo = 1

------------------------------------------------------------------
N and         |                     estimator                     
augmented     | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
--------------+---------------------------------------------------
200           |
   Unadjusted |      6.8285       7.4006       6.1668       9.2429
Reg. adjusted |      2.9870       5.9031       5.9011       5.9566
--------------+---------------------------------------------------
1000          |
   Unadjusted |      3.2044       5.1873       6.1418      10.4383
Reg. adjusted |      1.4702       6.1229       6.0783       6.1186
------------------------------------------------------------------

. 
. log close sim`sim'
      name:  sim12
       log:  U:\Stata\Ado\Devel\gmatch\sims/sim12/logfile.log
  log type:  text
 closed on:  18 Mar 2019, 19:38:59
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
