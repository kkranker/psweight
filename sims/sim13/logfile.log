------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  sim13
       log:  U:\Stata\Ado\Devel\gmatch\sims/sim13/logfile.log
  log type:  text
 opened on:  22 Mar 2019, 12:03:41

. 
. *! $Id: sim13.do,v f66ae0b6262a 2019/03/22 15:59:52 kkranker $
. *! BPO CBPS Simulation
. // See if the typo on page 215 of the I-R article explains differences between our and their results.
. //
. *! By Keith Kranker
. // Last updated $Date: 2019/03/22 15:59:52 $
. //
. // Copyright (C) Mathematica Policy Research, Inc.
. // This code cannot be copied, distributed or used without the express written
. // permission of Mathematica Policy Research, Inc.
. 
. mac list _sim
_sim:           13

. 
. // DGP is saved in a separate .ado file
. adopath ++ "./sims"
  [1]              "./sims"
  [2]  (BASE)      "C:\Program Files (x86)\Stata15\ado\base/"
  [3]  (SITE)      "C:\Program Files (x86)\Stata15\ado\site/"
  [4]              "."
  [5]  (PERSONAL)  "U:\Stata\Ado\personal/"
  [6]  (PLUS)      "U:\Stata\Ado\plus/"
  [7]  (OLDPLACE)  "C:\Users\kkranker\Documents\Stata\Ado/"
  [8]              "U:\Stata\Ado\personal"
  [9]              "U:\Stata\Ado\plus"
  [10]             "U:\Stata\Stata-Common-Code"
  [11]             "C:\Users\kkranker\Documents\Stata\Stata-Common-Code"

. which dgp_ksir
./sims\dgp_ksir.ado
*! $Id: dgp_ksir.ado,v f66ae0b6262a 2019/03/22 15:59:52 kkranker $
*! Data generating processe (DGP) senarios from:
*! By Keith Kranker

. which onerep_ksir_means
./sims\onerep_ksir_means.ado
*! $Id: onerep_ksir_means.ado,v f66ae0b6262a 2019/03/22 15:59:52 kkranker $
*! One replication of the Simulations with DGP_KSIR.ADO
*! By Keith Kranker

. which sim_reshape
./sims\sim_reshape.ado
*! $Id: sim_reshape.ado,v f66ae0b6262a 2019/03/22 15:59:52 kkranker $
*! Reshapes the outpute from simmulate: from wide to tall
*! By Keith Kranker

. 
. // control simulations
. local reps 2500

. 
. // other settings
. set seed `sim'  //  1 for simulation 1, 2 for simulation 2, etc.

. set matsize `c(max_matsize)'

. set maxiter 50

. set scheme mpr

. 
. // ------------------------------------------------------------------------
. // setup simulations
. // ------------------------------------------------------------------------
. 
. // options
. parallel setclusters `=min(6, c(processors_max)-1)'
N Clusters: 6
Stata dir:  C:\Program Files (x86)\Stata15/StataMP-64.exe

. local simopts    expr(_b) reps(\`reps') processors(`=c(processors_max)')

. local commonopts n(200 1000) ///
>                  estimators(ipw_true_ps ipw ipwcbps cbps) ///
>                  iter(`c(maxiter)') cformat(%9.3fc) pformat(%5.3f) sformat(%7.3f) ///
>                  quietly

. 
. // ------------------------------------------------------------------------
. // multiple matching approaches
. // difference in means and augmented
. // with the I-R definition of X4
. // ------------------------------------------------------------------------
. 
. onerep_ksir_means, `commonopts' irversion
(obs 1,000)

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
           y |        484    198.2987    37.04038   93.72253   303.5701
(1,000 real changes made)
(0 observations deleted)



--------------------
I_1
--------------------
Scenario: I
True mu:  210
N:        1000
--------------------


(800 observations deleted)



--------------------
I_2
--------------------
Scenario: I
True mu:  210
N:        200
--------------------


---------------------------------------------------------------------------------
                |      Coef.
----------------+----------------------------------------------------------------
I_1             |
              N |  1,000.000
             Nt |    484.000
           true |    210.000
----------------+----------------------------------------------------------------
I_1_ipw_true_ps |
     impact_est |    222.165
           bias |     12.165
      error_sqr |    147.992
----------------+----------------------------------------------------------------
I_1_ipw         |
     impact_est |    227.738
           bias |     17.738
      error_sqr |    314.634
----------------+----------------------------------------------------------------
I_1_ipwcbps     |
     impact_est |    224.848
           bias |     14.848
      error_sqr |    220.448
----------------+----------------------------------------------------------------
I_1_cbps        |
     impact_est |    256.833
           bias |     46.833
      error_sqr |  2,193.303
----------------+----------------------------------------------------------------
I_2             |
              N |    200.000
             Nt |     85.000
           true |    210.000
----------------+----------------------------------------------------------------
I_2_ipw_true_ps |
     impact_est |    217.360
           bias |      7.360
      error_sqr |     54.167
----------------+----------------------------------------------------------------
I_2_ipw         |
     impact_est |    218.186
           bias |      8.186
      error_sqr |     67.017
----------------+----------------------------------------------------------------
I_2_ipwcbps     |
     impact_est |    217.372
           bias |      7.372
      error_sqr |     54.347
----------------+----------------------------------------------------------------
I_2_cbps        |
     impact_est |    219.383
           bias |      9.383
      error_sqr |     88.036
---------------------------------------------------------------------------------

. drop _all

. 
. parallel sim, `simopts': onerep_ksir_means, `commonopts' irversion
Warning: No data loaded.
--------------------------------------------------------------------------------
Parallel Computing with Stata
Clusters   : 6
pll_id     : 7u5gd8ynl1
Running at : U:\Stata\Ado\Devel\gmatch
Randtype   : datetime
Waiting for the clusters to finish...
cluster 0002 has exited without error...
cluster 0005 has exited without error...
cluster 0001 has exited without error...
cluster 0006 has exited without error...
cluster 0004 has exited without error...
cluster 0003 has exited without error...
--------------------------------------------------------------------------------
Enter -parallel printlog #- to checkout logfiles.
--------------------------------------------------------------------------------

. 
. qui compress

. save sims/sim`sim'/Data_Unprocessed_1.dta, replace
file sims/sim13/Data_Unprocessed_1.dta saved

. 
. sim_reshape

Before reshape:


Contains data from sims/sim13/Data_Unprocessed_1.dta
  obs:         2,500                          simulate: onerep_ksir_means
 vars:            30                          22 Mar 2019 13:08
 size:       270,000                          
Sorted by: 
2 prefixes:
_prefixes:      I_1 I_2
4 estimators:
_ests:          ipw_true_ps ipw ipwcbps cbps
(simulate: onerep_ksir_means)
(19,992 missing values generated)
(19,992 missing values generated)
(19992 real changes made, 19992 to missing)
(19,992 missing values generated)

After reshape:


Contains data from D:\TEMP\kkranker\ST_4710_000001.tmp
  obs:        20,000                          simulate: onerep_ksir_means
 vars:            16                          22 Mar 2019 13:08
 size:     1,060,000                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
result          byte    %35.0g     result     
dataset         byte    %10.0g                
dgp             byte    %8.0g      dgp        
true            int     %7.4f                 
N               int     %7.0g                 
estimator       byte    %11.0g     est        
augmented       byte    %13.0g     aug        
rep             int     %9.0g                 
Nt              int     %7.0g                 
impact_est      float   %7.4f                 
bias            float   %7.4f                 
error_sqr       float   %7.4f                 
rmse            double  %7.4f                 
impact_est_var  double  %7.4f                 
mae             float   %7.4f                 
pct_bias        double  %6.1f                 
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: result  dataset  dgp  true  N  estimator  augmented  rep
     Note: Dataset has changed since last saved.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
      result |     20,000         4.5    2.291345          1          8
     dataset |     20,000         1.5    .5000125          1          2
         dgp |     20,000           8           0          8          8
        true |     20,000         210           0        210        210
           N |     20,000         600      400.01        200       1000
   estimator |     20,000         6.5     2.69265          2          9
   augmented |     20,000           0           0          0          0
         rep |     20,000      1250.5    721.7058          1       2500
          Nt |     20,000    300.1532    200.4867         72        552
  impact_est |     19,998    223.8777    10.95992   191.4436   349.1238
        bias |     19,998    13.87774    10.95992  -18.55635   139.1239
   error_sqr |     19,998    312.7056    915.1532   .0000298   19355.45
        rmse |          8     16.6626    6.334015   10.06646   26.98831
impact_est~r |          8    102.2864    102.1812   2.270083   305.1536
         mae |          8    11.78562    2.817738   9.518923   16.79617
    pct_bias |          8    216.2736    181.6421   117.7834    660.599
Number of rows:

--------------------------
augmented,  |  true and N 
dgp and     | - 210.0000 -
estimator   |   200   1000
------------+-------------
Unadjusted  |
I           |
IPW_TRUE_PS | 2,500  2,500
    IPWCBPS | 2,500  2,500
       CBPS | 2,500  2,500
        IPW | 2,500  2,500
--------------------------
Number of rows with nonmissing impact_est:

--------------------------
augmented,  |  true and N 
dgp and     | - 210.0000 -
estimator   |   200   1000
------------+-------------
Unadjusted  |
I           |
IPW_TRUE_PS | 2,500  2,500
    IPWCBPS | 2,500  2,500
       CBPS | 2,498  2,500
        IPW | 2,500  2,500
--------------------------
Number of rows with nonmissing rmse:

------------------------
augmented,  | true and N
dgp and     | - 210.00 -
estimator   |  200  1000
------------+-----------
Unadjusted  |
I           |
IPW_TRUE_PS |    1     1
    IPWCBPS |    1     1
       CBPS |    1     1
        IPW |    1     1
------------------------

. gen irversion = 1

. 
. tempfile f1

. save "`f1'", replace
(note: file D:\TEMP\kkranker\ST_4710_000001.tmp not found)
file D:\TEMP\kkranker\ST_4710_000001.tmp saved

. drop _all

. 
. // ------------------------------------------------------------------------
. // multiple matching approaches
. // difference in means and augmented
. // with the K-S definition of X4
. // ------------------------------------------------------------------------
. 
. onerep_ksir_means, `commonopts'
(obs 1,000)
(0 observations deleted)



--------------------
I_1
--------------------
Scenario: I
True mu:  210
N:        1000
--------------------


(800 observations deleted)



--------------------
I_2
--------------------
Scenario: I
True mu:  210
N:        200
--------------------


---------------------------------------------------------------------------------
                |      Coef.
----------------+----------------------------------------------------------------
I_1             |
              N |  1,000.000
             Nt |    475.000
           true |    210.000
----------------+----------------------------------------------------------------
I_1_ipw_true_ps |
     impact_est |    211.071
           bias |      1.071
      error_sqr |      1.146
----------------+----------------------------------------------------------------
I_1_ipw         |
     impact_est |    218.264
           bias |      8.264
      error_sqr |     68.302
----------------+----------------------------------------------------------------
I_1_ipwcbps     |
     impact_est |    216.272
           bias |      6.272
      error_sqr |     39.338
----------------+----------------------------------------------------------------
I_1_cbps        |
     impact_est |    232.284
           bias |     22.284
      error_sqr |    496.590
----------------+----------------------------------------------------------------
I_2             |
              N |    200.000
             Nt |     91.000
           true |    210.000
----------------+----------------------------------------------------------------
I_2_ipw_true_ps |
     impact_est |    209.630
           bias |     -0.370
      error_sqr |      0.137
----------------+----------------------------------------------------------------
I_2_ipw         |
     impact_est |    215.887
           bias |      5.887
      error_sqr |     34.658
----------------+----------------------------------------------------------------
I_2_ipwcbps     |
     impact_est |    214.369
           bias |      4.369
      error_sqr |     19.092
----------------+----------------------------------------------------------------
I_2_cbps        |
     impact_est |    231.736
           bias |     21.736
      error_sqr |    472.460
---------------------------------------------------------------------------------

. drop _all

. 
. parallel sim, `simopts': onerep_ksir_means, `commonopts'
Warning: No data loaded.
--------------------------------------------------------------------------------
Parallel Computing with Stata
Clusters   : 6
pll_id     : orwo5qp123
Running at : U:\Stata\Ado\Devel\gmatch
Randtype   : datetime
Waiting for the clusters to finish...
cluster 0005 has exited without error...
cluster 0001 has exited without error...
cluster 0006 has exited without error...
cluster 0003 has exited without error...
cluster 0002 has exited without error...
cluster 0004 has exited without error...
--------------------------------------------------------------------------------
Enter -parallel printlog #- to checkout logfiles.
--------------------------------------------------------------------------------

. 
. qui compress

. save sims/sim`sim'/Data_Unprocessed_0.dta, replace
file sims/sim13/Data_Unprocessed_0.dta saved

. 
. sim_reshape

Before reshape:


Contains data from sims/sim13/Data_Unprocessed_0.dta
  obs:         2,500                          simulate: onerep_ksir_means
 vars:            30                          22 Mar 2019 14:13
 size:       270,000                          
Sorted by: 
2 prefixes:
_prefixes:      I_1 I_2
4 estimators:
_ests:          ipw_true_ps ipw ipwcbps cbps
(simulate: onerep_ksir_means)
(19,992 missing values generated)
(19,992 missing values generated)
(19992 real changes made, 19992 to missing)
(19,992 missing values generated)

After reshape:


Contains data from D:\TEMP\kkranker\ST_4710_000002.tmp
  obs:        20,000                          simulate: onerep_ksir_means
 vars:            16                          22 Mar 2019 14:13
 size:     1,060,000                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
result          byte    %35.0g     result     
dataset         byte    %10.0g                
dgp             byte    %8.0g      dgp        
true            int     %7.4f                 
N               int     %7.0g                 
estimator       byte    %11.0g     est        
augmented       byte    %13.0g     aug        
rep             int     %9.0g                 
Nt              int     %7.0g                 
impact_est      float   %7.4f                 
bias            float   %7.4f                 
error_sqr       float   %7.4f                 
rmse            double  %7.4f                 
impact_est_var  double  %7.4f                 
mae             float   %7.4f                 
pct_bias        double  %6.1f                 
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: result  dataset  dgp  true  N  estimator  augmented  rep
     Note: Dataset has changed since last saved.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
      result |     20,000         4.5    2.291345          1          8
     dataset |     20,000         1.5    .5000125          1          2
         dgp |     20,000           8           0          8          8
        true |     20,000         210           0        210        210
           N |     20,000         600      400.01        200       1000
   estimator |     20,000         6.5     2.69265          2          9
   augmented |     20,000           0           0          0          0
         rep |     20,000      1250.5    721.7058          1       2500
          Nt |     20,000    300.1478    200.4789         79        554
  impact_est |     19,997    214.5189    12.43007   128.2271   327.9137
        bias |     19,997    4.518867    12.43007  -81.77295   117.9137
   error_sqr |     19,997    174.9191     770.082   9.34e-10   13903.63
        rmse |          8    11.26726    7.408232   2.236686   23.10086
impact_est~r |          8    128.8646    133.2387    4.99842   387.7167
         mae |          8    3.871141    2.424045    1.49046   8.402853
    pct_bias |          8     31.1474    30.97556  -3.561961   81.81773
Number of rows:

--------------------------
augmented,  |  true and N 
dgp and     | - 210.0000 -
estimator   |   200   1000
------------+-------------
Unadjusted  |
I           |
IPW_TRUE_PS | 2,500  2,500
    IPWCBPS | 2,500  2,500
       CBPS | 2,500  2,500
        IPW | 2,500  2,500
--------------------------
Number of rows with nonmissing impact_est:

--------------------------
augmented,  |  true and N 
dgp and     | - 210.0000 -
estimator   |   200   1000
------------+-------------
Unadjusted  |
I           |
IPW_TRUE_PS | 2,500  2,500
    IPWCBPS | 2,500  2,500
       CBPS | 2,497  2,500
        IPW | 2,500  2,500
--------------------------
Number of rows with nonmissing rmse:

------------------------
augmented,  | true and N
dgp and     | - 210.00 -
estimator   |  200  1000
------------+-----------
Unadjusted  |
I           |
IPW_TRUE_PS |    1     1
    IPWCBPS |    1     1
       CBPS |    1     1
        IPW |    1     1
------------------------

. gen irversion = 0

. 
. 
. // ------------------------------------------------------------------------
. // summarize results
. // ------------------------------------------------------------------------
. 
. label define irversion 0 "Kang-Shafler" 1 "Ima-Ratkovic"

. label val irversion irversion

. append using "`f1'"
(label dgp already defined)
(label est already defined)
(label aug already defined)
(label result already defined)

. 
. qui compress

. save sims/sim`sim'/Data.dta, replace
file sims/sim13/Data.dta saved

. 
. assert augmented[1]==augmented

. assert augmented[1]==0

. label define aug 0 "IPW-POP", replace

. 
. table irversion estimator, by(N) c(count bias)

-----------------------------------------------------------------
N and        |                     estimator                     
irversion    | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
-------------+---------------------------------------------------
200          |
Kang-Shafler |       2,500        2,500        2,497        2,500
Ima-Ratkovic |       2,500        2,500        2,498        2,500
-------------+---------------------------------------------------
1000         |
Kang-Shafler |       2,500        2,500        2,500        2,500
Ima-Ratkovic |       2,500        2,500        2,500        2,500
-----------------------------------------------------------------

. 
. foreach v of var impact_est rmse impact_est_var bias rmse  pct_bias mae {
  2.   di _n(2) as res `"`v'  `:var lab `v''"'
  3.   table irversion estimator, by(N) c(mean `v')
  4. }


impact_est  

-----------------------------------------------------------------
N and        |                     estimator                     
irversion    | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
-------------+---------------------------------------------------
200          |
Kang-Shafler |    209.8480     210.7385     222.0867     211.9953
Ima-Ratkovic |    219.8202     220.8062     230.5752     221.7758
-------------+---------------------------------------------------
1000         |
Kang-Shafler |    209.9204     213.0067     223.5993     214.9652
Ima-Ratkovic |    219.9531     222.8559     231.0481     224.1929
-----------------------------------------------------------------


rmse  

-----------------------------------------------------------------
N and        |                     estimator                     
irversion    | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
-------------+---------------------------------------------------
200          |
Kang-Shafler |      4.9509       7.8695      23.1009       9.8349
Ima-Ratkovic |     10.8403      13.0962      26.9883      14.6074
-------------+---------------------------------------------------
1000         |
Kang-Shafler |      2.2367       9.0720      21.4734      11.6000
Ima-Ratkovic |     10.0665      15.2596      25.4836      16.9590
-----------------------------------------------------------------


impact_est_var  

-----------------------------------------------------------------
N and        |                     estimator                     
irversion    | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
-------------+---------------------------------------------------
200          |
Kang-Shafler |     24.4978      61.4076     387.7167      92.7805
Ima-Ratkovic |     21.0847      54.7583     305.1536      74.7368
-------------+---------------------------------------------------
1000         |
Kang-Shafler |      4.9984      73.2907     276.2741     109.9511
Ima-Ratkovic |      2.2701      67.6082     206.4770      86.2022
-----------------------------------------------------------------


bias  

-----------------------------------------------------------------
N and        |                     estimator                     
irversion    | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
-------------+---------------------------------------------------
200          |
Kang-Shafler |     -0.1520       0.7385      12.0867       1.9952
Ima-Ratkovic |      9.8202      10.8062      20.5752      11.7758
-------------+---------------------------------------------------
1000         |
Kang-Shafler |     -0.0796       3.0067      13.5993       4.9652
Ima-Ratkovic |      9.9531      12.8559      21.0481      14.1929
-----------------------------------------------------------------


rmse  

-----------------------------------------------------------------
N and        |                     estimator                     
irversion    | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
-------------+---------------------------------------------------
200          |
Kang-Shafler |      4.9509       7.8695      23.1009       9.8349
Ima-Ratkovic |     10.8403      13.0962      26.9883      14.6074
-------------+---------------------------------------------------
1000         |
Kang-Shafler |      2.2367       9.0720      21.4734      11.6000
Ima-Ratkovic |     10.0665      15.2596      25.4836      16.9590
-----------------------------------------------------------------


pct_bias  

-----------------------------------------------------------------
N and        |                     estimator                     
irversion    | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
-------------+---------------------------------------------------
200          |
Kang-Shafler |        -3.1          9.4         61.4         20.7
Ima-Ratkovic |       213.9        146.0        117.8        136.2
-------------+---------------------------------------------------
1000         |
Kang-Shafler |        -3.6         35.1         81.8         47.4
Ima-Ratkovic |       660.6        156.4        146.5        152.9
-----------------------------------------------------------------


mae  

-----------------------------------------------------------------
N and        |                     estimator                     
irversion    | IPW_TRUE_PS      IPWCBPS         CBPS          IPW
-------------+---------------------------------------------------
200          |
Kang-Shafler |      3.2124       3.1702       6.8025       3.3063
Ima-Ratkovic |      9.5189       9.5243      15.4158      10.1321
-------------+---------------------------------------------------
1000         |
Kang-Shafler |      1.4905       2.0634       8.4029       2.5210
Ima-Ratkovic |      9.8364      11.0954      16.7962      11.9658
-----------------------------------------------------------------

. 
. log close sim`sim'
      name:  sim13
       log:  U:\Stata\Ado\Devel\gmatch\sims/sim13/logfile.log
  log type:  text
 closed on:  22 Mar 2019, 14:13:40
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
